angular.module("oil.bindOldCardCtrl",["oil.UtilService","oil.services","oil.UserService"]).controller("bindOldCardCtrl",function($scope,$log,$ionicHistory,$state,Util,servicesRequest,User,$ionicLoading,$location,Storage,$rootScope){$scope.getBack=function(){$ionicHistory.goBack();};$scope.$on("$ionicView.beforeEnter",function(){$rootScope.hideTabs=true;});$scope.clickGoBack=function(){$ionicHistory.goBack();};$scope.bindOldInfo={cardid:"",phone:"",cardpwd:""};$scope.bindOldCard=function(){var token=$location.search().token;if(token==null||token==""){token=User.getToken();}
  Storage.set("token",token);servicesRequest.bindOldCard($scope.bindOldInfo.cardid,$scope.bindOldInfo.phone,$scope.bindOldInfo.cardpwd,token).success(function(data){var statusCode=data.code;var message=data.message;if(statusCode==100){var content=JSON.parse(data.content);Util.ionicPopupAlert("绑定成功").then(function(res){$state.go("tab.home");});$scope.contents=data.content;}else{var flag=Storage.get("flag");if(flag==null||flag==""){flag=0;}
    flag=flag+1;Storage.set("flag",+flag);if(flag<3){Util.ionicPopupAlert("资料信息不一致，确认后继续");}else{Storage.set("flag",0);Util.ionicPopupAlert(message).then(function(res){$state.go("tab.addMember");});}}}).error(function(error){Util.ionicPopupAlert("会员卡绑定失败，请重试！");}).finally(function(){});};});
